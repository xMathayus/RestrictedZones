<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zone Management</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@recogito/annotorious-openseadragon@2.7.17/dist/annotorious.min.css">

    <style>
        #openseadragon {
            width: 100vw;
            height: 100vh;
        }

        #cursorViewportPosition,
        .input-overlay,
        .textHelper,
        .button-overlay {
            position: fixed;
            color: white;
            font-size: 15px;
            z-index: 9999;
        }

        #cursorViewportPosition {
            background-color: rgba(0, 0, 0, 0.5);
            border: 2px solid black;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
            padding: 10px;
            right: 1vw;
            bottom: 1vh;
        }

        .textHelper {
            background-color: rgba(0, 0, 0, 0.5);
            border: 2px solid black;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
            padding: 10px;
            top: 1vh;
            left: 1vw;
        }

        .input-overlay {
            top: 1vh;
            right: 2vw;
            min-width: 10vw;
            max-width: 30vw;
        }

        .input-row {
            padding: 5px;
            background-color: rgba(0, 0, 0, 0.5);
            border: 1px solid black;
            box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 5px;
        }

        .button-overlay {
            bottom: 1vh;
            left: 1vw;
            padding: 5px;
            background-color: rgba(0, 0, 0, 0.5);
            border: 2px solid black;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>

<body>
    <div id="openseadragon"></div>
    <div class="input-overlay">
        <div id="zones"></div>
    </div>
    <span id="cursorViewportPosition"></span>

    <div class="textHelper">
        Press Shift+LeftClick to create zones.<br>
        Double LeftClick to end creating zones.<br>
        Do not overlap zones.<br>
        Export the zones when done.<br>
        <hr>
        <strong>Allow PvP:</strong> Allows players to damage each other within the zone.<br>
        <hr>
        Made by #pw_another<br>
        Edited by #Mathayuss (To work with Server Restriction Mod)<br>
    </div>

    <div class="button-overlay d-flex flex-column">
        <button id="exportButton" class="btn btn-primary btn-sm">Export</button>
    </div>

    <!-- Zone Options Modal -->
    <div id="zoneOptionsModal" class="modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Zone Options</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="zoneNameInput" class="form-label">Zone Name</label>
                        <input type="text" class="form-control" id="zoneNameInput">
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="allowPvPInput">
                        <label class="form-check-label" for="allowPvPInput">
                            Allow PvP
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveZoneOptionsButton">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/openseadragon"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/@recogito/annotorious-openseadragon@2.7.17/dist/openseadragon-annotorious.min.js"></script>

    <script>
        var viewer = OpenSeadragon({
            showNavigationControl: false,
            showZoomControl: false,
            id: "openseadragon",
            tileSources: [{
                type: 'image',
                url: 'Map.jpg'  <!-- Make sure the path to your map image is correct -->
            }],
            minZoomLevel: 1,
            maxZoomLevel: 10,
            visibilityRatio: 1.0,
            defaultZoomLevel: 1,
            constrainDuringPan: true,
            zoomPerClick: 1
        });

        var config = {
            disableEditor: true,
            allowEmpty: true
        };

        function onMouseTrackerMove(event) {
            var viewerX = event.position.x;
            var viewerY = event.position.y;
            var windowPoint = new OpenSeadragon.Point(viewerX, viewerY);
            var viewportPoint = viewer.viewport.windowToImageCoordinates(windowPoint);
            var imageSize = viewer.source.dimensions;

            var mappedX = (viewportPoint.x / imageSize.x) * 2000 - 1000;
            var mappedY = ((imageSize.y - viewportPoint.y) / imageSize.y) * 2000 - 1000;

            $("#cursorViewportPosition").text(Math.round(mappedX) + "," + Math.round(mappedY));
        }

        new OpenSeadragon.MouseTracker({
            element: document,
            moveHandler: onMouseTrackerMove
        }).setTracking(true);

        var anno = OpenSeadragon.Annotorious(viewer, config);
        anno.setDrawingTool("polygon");

        function CreateInput(zoneName, annotationId, allowPvP) {
            const inputRow = $(`
            <div class="input-row row no-gutters" zone-id="${annotationId}" zone-name="${zoneName}" style="background-color: rgba(0, 0, 0, 0.7); border: 1px solid #ccc; box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.5); padding: 5px; margin-bottom: 5px;">
                <div class="col-12 d-flex align-items-center">
                    <span class="zone-name-label" style="margin-right: 10px; color: white; font-weight: bold; font-size: 14px; cursor: pointer;">${zoneName}</span>
                    <input type="checkbox" class="allow-pvp-checkbox" ${allowPvP ? 'checked' : ''} title="Allow PvP" style="margin-left: 10px; margin-right: 5px;"> <span style="color: white; font-size: 12px;">Allow PvP</span>
                </div>
            </div>
            `);

            return inputRow;
        }
    </script>

    <script src="annotationsEvents.js"></script>

</body>

</html>
