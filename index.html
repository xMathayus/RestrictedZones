<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zone Management</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@recogito/annotorious-openseadragon@2.7.17/dist/annotorious.min.css">

    <style>
        #openseadragon {
            width: 100vw;
            height: 100vh;
        }

        #cursorViewportPosition,
        .input-overlay,
        .textHelper,
        .button-overlay {
            position: fixed;
            color: white;
            font-size: 15px;
            z-index: 9999;
        }

        #cursorViewportPosition {
            background-color: rgba(0, 0, 0, 0.5);
            border: 2px solid black;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
            padding: 10px;
            right: 1vw;
            bottom: 1vh;
        }

        .textHelper {
            background-color: rgba(0, 0, 0, 0.5);
            border: 2px solid black;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
            padding: 10px;
            top: 1vh;
            left: 1vw;
        }

        .input-overlay {
            top: 1vh;
            right: 2vw;
            min-width: 10vw;
            max-width: 30vw;
        }

        .input-row {
            padding: 5px;
            background-color: rgba(0, 0, 0, 0.5);
            border: 1px solid black;
            box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 5px;
        }

        .button-overlay {
            bottom: 1vh;
            left: 1vw;
            padding: 5px;
            background-color: rgba(0, 0, 0, 0.5);
            border: 2px solid black;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>

<body>
    <div id="openseadragon"></div>
    <div class="input-overlay">
        <div id="zones"></div>
    </div>
    <span id="cursorViewportPosition"></span>

    <div class="textHelper">
        Press Shift+LeftClick to create zones.<br>
        Double LeftClick to end creating zones.<br>
        Do not overlap zones.<br>
        Export the zones when done.<br>
        <hr>
        Made by #pw_another<br>
        Edited by #Mathayuss (To work with Server Restriction Mod)<br>
    </div>

    <div class="button-overlay d-flex flex-column">
        <!-- Initially disable the export button -->
        <button id="exportButton" class="btn btn-primary btn-sm" disabled>Export</button>
    </div>

    <!-- Zone Options Modal -->
    <div id="zoneOptionsModal" class="modal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Zone Options</h5>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="zoneNameInput" class="form-label">Zone Name</label>
                        <input type="text" class="form-control" id="zoneNameInput">
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="allowBuildInput" data-bs-toggle="tooltip" data-bs-placement="right" title="Allows players to build within the zone.">
                        <label class="form-check-label" for="allowBuildInput">
                            Allow Build
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="allowDismantleInput" data-bs-toggle="tooltip" data-bs-placement="right" title="Allows players to dismantle objects within the zone.">
                        <label class="form-check-label" for="allowDismantleInput">
                            Allow Dismantle
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="allowObjectDamageInput" data-bs-toggle="tooltip" data-bs-placement="right" title="Allows objects to be damaged within the zone.">
                        <label class="form-check-label" for="allowObjectDamageInput">
                            Allow Object Damage
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="allowPvPInput" data-bs-toggle="tooltip" data-bs-placement="right" title="Allows players to damage each other within the zone.">
                        <label class="form-check-label" for="allowPvPInput">
                            Allow PvP
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="allowPalPvpInput" data-bs-toggle="tooltip" data-bs-placement="right" title="Allows player-controlled NPCs to attack within the zone.">
                        <label class="form-check-label" for="allowPalPvpInput">
                            Allow Pal PvP
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="allowNpcDamageInput" data-bs-toggle="tooltip" data-bs-placement="right" title="Allows wild NPCs to damage players within the zone.">
                        <label class="form-check-label" for="allowNpcDamageInput">
                            Allow NPC Damage
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="allowPlayerDamageToNpcInput" data-bs-toggle="tooltip" data-bs-placement="right" title="Allows players to damage wild NPCs within the zone.">
                        <label class="form-check-label" for="allowPlayerDamageToNpcInput">
                            Allow Player Damage To NPC
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="allowPalDamageToNpcInput" data-bs-toggle="tooltip" data-bs-placement="right" title="Allows player-controlled NPCs to damage wild NPCs within the zone.">
                        <label class="form-check-label" for="allowPalDamageToNpcInput">
                            Allow Pal Damage To NPC
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelZoneButton" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveZoneOptionsButton">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/openseadragon"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/@recogito/annotorious-openseadragon@2.7.17/dist/openseadragon-annotorious.min.js"></script>

    <script>
        var viewer = OpenSeadragon({
            showNavigationControl: false,
            showZoomControl: false,
            id: "openseadragon",
            tileSources: [{
                type: 'image',
                url: 'Map.jpg'  <!-- Make sure the path to your map image is correct -->
            }],
            minZoomLevel: 1,
            maxZoomLevel: 10,
            visibilityRatio: 1.0,
            defaultZoomLevel: 1,
            constrainDuringPan: true,
            zoomPerClick: 1
        });

        var config = {
            disableEditor: true,
            allowEmpty: true
        };

        function onMouseTrackerMove(event) {
            var viewerX = event.position.x;
            var viewerY = event.position.y;
            var windowPoint = new OpenSeadragon.Point(viewerX, viewerY);
            var viewportPoint = viewer.viewport.windowToImageCoordinates(windowPoint);
            var imageSize = viewer.source.dimensions;

            var mappedX = (viewportPoint.x / imageSize.x) * 2000 - 1000;
            var mappedY = ((imageSize.y - viewportPoint.y) / imageSize.y) * 2000 - 1000;

            $("#cursorViewportPosition").text(Math.round(mappedX) + "," + Math.round(mappedY));
        }

        new OpenSeadragon.MouseTracker({
            element: document,
            moveHandler: onMouseTrackerMove
        }).setTracking(true);

        var anno = OpenSeadragon.Annotorious(viewer, config);
        anno.setDrawingTool("polygon");

        let globaIDIndex = 0;
        let currentAnnotationId = null;
        let editingZoneElement = null;
        let pendingExport = false; // To track if an export is pending

        // Utility function to hide tooltips on checkbox click
        function hideTooltipOnCheckboxClick() {
            $('input[type="checkbox"]').on('click', function () {
                $(this).tooltip('hide'); // Explicitly hide tooltip on click
            });
        }

        // Utility function to check if the export button should be enabled
        function updateExportButtonState() {
            let enableExport = true;
            const zoneRows = $('#zones .input-row');

            // If no zones exist, disable export button
            if (zoneRows.length === 0) {
                enableExport = false;
            }

            zoneRows.each(function () {
                const zoneName = $(this).attr('zone-name');
                // Ensure any non-empty name enables the export button, including auto-generated ones
                if (!zoneName.trim()) {
                    enableExport = false;
                    return false; // Break out of the loop if any zone has an empty name
                }
            });

            $('#exportButton').prop('disabled', !enableExport);
        }

        $(document).ready(function() {
            // Initialize tooltips with no delay
            $('[data-bs-toggle="tooltip"]').tooltip({
                delay: { show: 100, hide: 0 } // Reduce the show delay to 100ms
            });

            hideTooltipOnCheckboxClick();
            updateExportButtonState(); // Ensure the button is disabled on page load
        });

        anno.on('createAnnotation', async (annotation, overrideId) => {
            overrideId(String(globaIDIndex));
            currentAnnotationId = globaIDIndex;

            // Disable the export button when a new zone is created
            $('#exportButton').prop('disabled', true);

            // Show the modal to get the zone options (only for initial creation)
            $('#zoneOptionsModal').modal('show');
        });

        $('#saveZoneOptionsButton').click(function () {
            let zoneName = $('#zoneNameInput').val();
            const allowBuild = $('#allowBuildInput').is(':checked');
            const allowDismantle = $('#allowDismantleInput').is(':checked');
            const allowObjectDamage = $('#allowObjectDamageInput').is(':checked');
            const allowPvP = $('#allowPvPInput').is(':checked');
            const allowPalPvp = $('#allowPalPvpInput').is(':checked');
            const allowNpcDamage = $('#allowNpcDamageInput').is(':checked');
            const allowPlayerDamageToNpc = $('#allowPlayerDamageToNpcInput').is(':checked');
            const allowPalDamageToNpc = $('#allowPalDamageToNpcInput').is(':checked');

            // Assign a default name if no name is provided
            if (!zoneName.trim()) {
                zoneName = `Zone ${currentAnnotationId + 1}`;
            }

            if (editingZoneElement) {
                // Update existing zone
                editingZoneElement.attr('zone-name', zoneName);
                editingZoneElement.find('.zone-name-label').text(zoneName);

                // Update data attributes for the zone
                editingZoneElement.data('allow-build', allowBuild);
                editingZoneElement.data('allow-dismantle', allowDismantle);
                editingZoneElement.data('allow-object-damage', allowObjectDamage);
                editingZoneElement.data('allow-pvp', allowPvP);
                editingZoneElement.data('allow-pal-pvp', allowPalPvp);
                editingZoneElement.data('allow-npc-damage', allowNpcDamage);
                editingZoneElement.data('allow-player-damage-to-npc', allowPlayerDamageToNpc);
                editingZoneElement.data('allow-pal-damage-to-npc', allowPalDamageToNpc);

                editingZoneElement = null; // Reset after editing
            } else {
                // Create new zone with data attributes
                const newZoneElement = CreateInput(zoneName, currentAnnotationId);
                newZoneElement.data('allow-build', allowBuild);
                newZoneElement.data('allow-dismantle', allowDismantle);
                newZoneElement.data('allow-object-damage', allowObjectDamage);
                newZoneElement.data('allow-pvp', allowPvP);
                newZoneElement.data('allow-pal-pvp', allowPalPvp);
                newZoneElement.data('allow-npc-damage', allowNpcDamage);
                newZoneElement.data('allow-player-damage-to-npc', allowPlayerDamageToNpc);
                newZoneElement.data('allow-pal-damage-to-npc', allowPalDamageToNpc);

                $('#zones').append(newZoneElement);
                globaIDIndex++;
            }

            $('#zoneOptionsModal').modal('hide');

            // Recheck if the export button should be enabled
            updateExportButtonState();

            // If an export was pending, trigger the export process now
            if (pendingExport) {
                pendingExport = false;
                $('#exportButton').trigger('click');
            }

            currentAnnotationId = null; // Reset after saving the zone
        });

        $('#cancelZoneButton').click(function () {
            // Delete the current zone if cancel is clicked
            if (currentAnnotationId !== null) {
                anno.removeAnnotation(String(currentAnnotationId));
                currentAnnotationId = null;
            }

            // Recheck if the export button should be enabled
            updateExportButtonState();
        });

        anno.on('selectAnnotation', function (annotation) {
            // Select the zone for possible editing in the side panel
            editingZoneElement = $(`div[zone-id='${annotation.id}']`);
        });

        anno.on('deleteAnnotation', function (annotation) {
            $(`div[zone-id='${annotation.id}']`).remove();
            updateExportButtonState(); // Recheck after deletion
        });

        anno.on('startSelection', function () {
            // Disable export when a new zone is being created
            $('#exportButton').prop('disabled', true);

            // Reset any previous editing or annotation states
            currentAnnotationId = null;
            editingZoneElement = null;
        });

        $('.input-overlay').on('click', '.zone-name-label', function () {
            const zoneNameLabel = $(this);
            const currentZoneElement = zoneNameLabel.closest('.input-row');

            // Get current zone values
            const currentName = currentZoneElement.attr('zone-name');
            const allowBuild = currentZoneElement.data('allow-build');
            const allowDismantle = currentZoneElement.data('allow-dismantle');
            const allowObjectDamage = currentZoneElement.data('allow-object-damage');
            const allowPvP = currentZoneElement.data('allow-pvp');
            const allowPalPvp = currentZoneElement.data('allow-pal-pvp');
            const allowNpcDamage = currentZoneElement.data('allow-npc-damage');
            const allowPlayerDamageToNpc = currentZoneElement.data('allow-player-damage-to-npc');
            const allowPalDamageToNpc = currentZoneElement.data('allow-pal-damage-to-npc');

            // Populate the modal with the current values
            $('#zoneNameInput').val(currentName);
            $('#allowBuildInput').prop('checked', allowBuild);
            $('#allowDismantleInput').prop('checked', allowDismantle);
            $('#allowObjectDamageInput').prop('checked', allowObjectDamage);
            $('#allowPvPInput').prop('checked', allowPvP);
            $('#allowPalPvpInput').prop('checked', allowPalPvp);
            $('#allowNpcDamageInput').prop('checked', allowNpcDamage);
            $('#allowPlayerDamageToNpcInput').prop('checked', allowPlayerDamageToNpc);
            $('#allowPalDamageToNpcInput').prop('checked', allowPalDamageToNpc);

            // Set the editing element
            editingZoneElement = currentZoneElement;

            // Show the modal to edit the zone options
            $('#zoneOptionsModal').modal('show');
        });

        $('#exportButton').click(function () {
            const zones = [];

            $('#zones .input-row').each(function () {
                const row = $(this);
                const zoneId = row.attr('zone-id');
                const zoneName = row.attr('zone-name');
                const allowBuild = row.data('allow-build');
                const allowDismantle = row.data('allow-dismantle');
                const allowObjectDamage = row.data('allow-object-damage');
                const allowPvP = row.data('allow-pvp');
                const allowPalPvp = row.data('allow-pal-pvp');
                const allowNpcDamage = row.data('allow-npc-damage');
                const allowPlayerDamageToNpc = row.data('allow-player-damage-to-npc');
                const allowPalDamageToNpc = row.data('allow-pal-damage-to-npc');
                const cords = [];

                // Get the annotation associated with this zone
                const annotation = anno.getAnnotationById(zoneId);
                if (annotation) {
                    const vectorPoints = annotation.target.selector.value;
                    const pointsMatch = vectorPoints.match(/points=['"]([^'"]+)['"]/);

                    if (pointsMatch && pointsMatch.length > 1) {
                        const pointsString = pointsMatch[1];
                        const pointsArray = pointsString.split(/\s+/);

                        pointsArray.forEach(point => {
                            const coords = point.split(',');
                            const mappedX = ((parseFloat(coords[0]) / 8192) * 2000 - 1000) * 463 + 157664;
                            const mappedY = ((parseFloat(coords[1]) / 8192) * -2000 + 1000) * 463 - 123467;
                            cords.push({ x: mappedX, y: mappedY });
                        });
                    }
                }

                // Only add the zone if it has valid coordinates
                if (cords.length > 0) {
                    zones.push({
                        name: zoneName,
                        allowBuild: allowBuild,
                        allowDismantle: allowDismantle,
                        allowObjectDamage: allowObjectDamage,
                        allowPvP: allowPvP,
                        allowPalPvp: allowPalPvp,
                        allowNpcDamage: allowNpcDamage,
                        allowPlayerDamageToNpc: allowPlayerDamageToNpc,
                        allowPalDamageToNpc: allowPalDamageToNpc,
                        cords: cords
                    });
                }
            });

            // Build the Lua string
            let luaString = `return {\n    restrictedZones = {\n`;

            zones.forEach(zone => {
                luaString += `        -- ${zone.name}\n`;
                luaString += `        {\n            allowBuild = ${zone.allowBuild},\n`;
                luaString += `            allowDismantle = ${zone.allowDismantle},\n`;
                luaString += `            allowObjectDamage = ${zone.allowObjectDamage},\n`;
                luaString += `            allowPvP = ${zone.allowPvP},\n`;
                luaString += `            allowPalPvp = ${zone.allowPalPvp},\n`;
                luaString += `            allowNpcDamage = ${zone.allowNpcDamage},\n`;
                luaString += `            allowPlayerDamageToNpc = ${zone.allowPlayerDamageToNpc},\n`;
                luaString += `            allowPalDamageToNpc = ${zone.allowPalDamageToNpc},\n`;
                luaString += `            cords = {\n`;
                zone.cords.forEach(cord => {
                    luaString += `                { x = ${cord.x}, y = ${cord.y} },\n`;
                });
                luaString += `            }\n        },\n`;
            });

            luaString += `    }\n}`;

            // Create a Blob and trigger download
            const blob = new Blob([luaString], { type: "application/lua" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'restrictedzones.lua';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });

        function CreateInput(zoneName, annotationId) {
            const inputRow = $(`
            <div class="input-row row no-gutters" zone-id="${annotationId}" zone-name="${zoneName}" style="background-color: rgba(0, 0, 0, 0.7); border: 1px solid #ccc; box-shadow: 0px 1px 3px rgba(0, 0, 0, 0.5); padding: 2px; margin-bottom: 3px;">
                <div class="col-12 d-flex align-items-center">
                    <span class="zone-name-label" style="margin-right: 5px; color: white; font-weight: bold; font-size: 18px; cursor: pointer;" data-bs-toggle="tooltip" title="Click to update settings">${zoneName}</span>
                </div>
            </div>
            `);

            return inputRow;
        }
    </script>

</body>

</html>
